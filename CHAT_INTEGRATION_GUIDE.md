# AI Chat Integration Guide

## üöÄ Overview

–ú–æ—â–Ω–∞—è AI-—á–∞—Ç —Å–∏—Å—Ç–µ–º–∞ —Å –ø–æ–ª–Ω–æ–π –∏–Ω—Ç–µ–≥—Ä–∞—Ü–∏–µ–π –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è. –ß–∞—Ç –ø–æ–Ω–∏–º–∞–µ—Ç –∫–æ–Ω—Ç–µ–∫—Å—Ç –ø–æ–≥–æ–¥—ã, –º–∞—Ä—à—Ä—É—Ç—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è, alerts –∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–µ–¥–ª–∞–≥–∞–µ—Ç —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤—É—é—â–∏–µ –¥–µ–π—Å—Ç–≤–∏—è.

## ‚ú® Key Features

### 1. **Context-Aware Conversations** üß†
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∑–∞–≥—Ä—É–∑–∫–∞ –ø–æ–≥–æ–¥—ã –Ω–∞ 7 –¥–Ω–µ–π
- –£—á–µ—Ç —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è
- –ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –∞–∫—Ç–∏–≤–Ω—ã–º–∏ alerts
- –ê–Ω–∞–ª–∏–∑ –ø–æ–≤–µ–¥–µ–Ω—á–µ—Å–∫–∏—Ö –ø–∞—Ç—Ç–µ—Ä–Ω–æ–≤
- Comfort predictions –¥–ª—è –ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∏—è

### 2. **Intent Detection & Navigation** üéØ
–ß–∞—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ —Ä–∞—Å–ø–æ–∑–Ω–∞–µ—Ç –Ω–∞–º–µ—Ä–µ–Ω–∏—è –∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è–µ—Ç –Ω–∞ –Ω—É–∂–Ω—ã–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã:

**–ü—Ä–∏–º–µ—Ä—ã:**
- "–Ø —Ö–æ—á—É —Å—ä–µ–∑–¥–∏—Ç—å –≤ –ê–ª–º–∞—Ç—ã" ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç `/route?to=–ê–ª–º–∞—Ç—ã`
- "–ö–∞–∫–∞—è –ø–æ–≥–æ–¥–∞?" ‚Üí –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç `/forecast`
- "–ü—Ä–æ–≤–µ—Ä—å alerts" ‚Üí –û—Ç–∫—Ä—ã–≤–∞–µ—Ç `/alerts`
- "–°–æ–∑–¥–∞—Ç—å –º–∞—Ä—à—Ä—É—Ç –∏–∑ –ê—Å—Ç–∞–Ω—ã –≤ –ê–ª–º–∞—Ç—ã" ‚Üí `/route?from=–ê—Å—Ç–∞–Ω–∞&to=–ê–ª–º–∞—Ç—ã`
- "–ü–æ–∫–∞–∂–∏ –∫–∞—Ä—Ç—É" ‚Üí `/forecast/map`
- "–ù–∞—Å—Ç—Ä–æ–π–∫–∏" ‚Üí `/settings`

### 3. **Scheduled Messages** ‚è∞
–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–µ —Å–æ–æ–±—â–µ–Ω–∏—è –≤ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω–æ–µ –≤—Ä–µ–º—è (–Ω–∞–ø—Ä–∏–º–µ—Ä, 8:00 —É—Ç—Ä–∞):
- –ü–æ–≥–æ–¥–Ω—ã–π –±—Ä–∏—Ñ–∏–Ω–≥ –Ω–∞ –¥–µ–Ω—å
- –†–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏ –ø–æ –æ–¥–µ–∂–¥–µ
- –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è –æ–± alerts
- –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—ã—Ö –º–∞—Ä—à—Ä—É—Ç–æ–≤
- –ö–æ–º—Ñ–æ—Ä—Ç-–∞–Ω–∞–ª–∏–∑

### 4. **Rich Message Components** üé®

#### WeatherForecastCard
```typescript
<WeatherForecastCard
  forecast={forecast7days}
  location="Astana"
  compact={false}
  showActions={true}
/>
```
- 7-–¥–Ω–µ–≤–Ω—ã–π –ø—Ä–æ–≥–Ω–æ–∑ —Å emoji
- –¢–µ–º–ø–µ—Ä–∞—Ç—É—Ä–∞ high/low
- Precipitation chance
- Comfort index badges
- Quick actions buttons

#### RoutePreviewCard
```typescript
<RoutePreviewCard
  from="Astana"
  to="Almaty"
  weather_condition="Clear"
  weather_emoji="‚òÄÔ∏è"
  warnings={["High wind expected"]}
  comfort_score={75}
/>
```
- –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –º–∞—Ä—à—Ä—É—Ç–∞
- –ü–æ–≥–æ–¥–∞ –≤–¥–æ–ª—å –ø—É—Ç–∏
- Warnings –∏ alerts
- –ö–Ω–æ–ø–∫–∞ "Plan Route"

#### AlertSummaryCard
```typescript
<AlertSummaryCard
  alerts={activeAlerts}
  showAll={false}
  onViewDetails={(id) => router.push(`/alerts/${id}`)}
/>
```
- –¶–≤–µ—Ç–æ–≤–∞—è –∏–Ω–¥–∏–∫–∞—Ü–∏—è severity
- Distance –¥–æ alert
- Quick actions

### 5. **Streaming Responses** ‚ö°
```typescript
// Enable streaming for real-time responses
const response = await fetch('/api/chat/enhanced', {
  method: 'POST',
  body: JSON.stringify({
    message: userMessage,
    stream: true
  })
});
```

## üì° API Endpoints

### `/api/chat/context` (GET)
–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–æ–ª–Ω–æ–≥–æ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ –¥–ª—è —á–∞—Ç–∞:
```bash
GET /api/chat/context?lat=51.1694&lng=71.4491&location=Astana
```

**Response:**
```json
{
  "context": {
    "weather": {
      "forecast_7day": [...],
      "current_conditions": {...},
      "week_summary": "..."
    },
    "routes": {
      "saved_routes": [...],
      "recent_routes": [...]
    },
    "behavior": {...},
    "alerts": {...},
    "contextual_prompt": "SYSTEM CONTEXT..."
  }
}
```

### `/api/chat/enhanced` (POST)
–û—Å–Ω–æ–≤–Ω–æ–π —á–∞—Ç endpoint —Å AI:
```typescript
POST /api/chat/enhanced
{
  "message": "–Ø —Ö–æ—á—É –ø–æ–µ—Ö–∞—Ç—å –≤ –ê–ª–º–∞—Ç—ã",
  "conversation_history": [...],
  "location": { lat: 51.1694, lng: 71.4491, name: "Astana" },
  "include_context": true,
  "stream": false
}
```

**Response:**
```json
{
  "message": "–ö–æ–Ω–µ—á–Ω–æ! –Ø –ø–æ–º–æ–≥—É –≤–∞–º —Å–ø–ª–∞–Ω–∏—Ä–æ–≤–∞—Ç—å –ø–æ–µ–∑–¥–∫—É...",
  "intent": {
    "type": "create_route",
    "confidence": 0.85,
    "entities": {
      "to_location": "–ê–ª–º–∞—Ç—ã"
    }
  },
  "navigation": {
    "page": "/route",
    "params": { "to": "–ê–ª–º–∞—Ç—ã" },
    "action_command": "CREATE_ROUTE|current|–ê–ª–º–∞—Ç—ã"
  },
  "suggestions": [
    "Show me weather along the route",
    "When is the best time to travel?",
    "Are there any alerts on this route?"
  ],
  "metadata": {
    "context_used": true,
    "model": "gpt-4o-mini",
    "weather_forecast": [...]
  }
}
```

### `/api/chat/scheduled` (POST)
–ì–µ–Ω–µ—Ä–∞—Ü–∏—è scheduled —Å–æ–æ–±—â–µ–Ω–∏–π:
```typescript
POST /api/chat/scheduled
{
  "user_id": "user_xxx",
  "trigger_time": "2025-10-05T08:00:00Z",
  "trigger_type": "daily_briefing",
  "location": { lat: 51.1694, lng: 71.4491, name: "Astana" }
}
```

**Response:**
```json
{
  "message": {
    "message_id": "scheduled-xxx",
    "greeting": "Good morning! ‚òÄÔ∏è",
    "content": {
      "summary": "...",
      "highlights": ["üåßÔ∏è High chance of rain...", "..."],
      "recommendations": ["üëï Light clothing...", "..."],
      "warnings": []
    },
    "weather_snapshot": {...},
    "quick_actions": [...],
    "conversation_starters": [...]
  }
}
```

## üéÆ Chat UI Components

### Message Types

1. **Text Message** - –û–±—ã—á–Ω–æ–µ —Ç–µ–∫—Å—Ç–æ–≤–æ–µ —Å–æ–æ–±—â–µ–Ω–∏–µ
2. **Weather Card** - –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ–≥–æ–¥—ã
3. **Route Preview** - –ü—Ä–µ–¥–ø—Ä–æ—Å–º–æ—Ç—Ä –º–∞—Ä—à—Ä—É—Ç–∞
4. **Alert Summary** - –°–≤–æ–¥–∫–∞ alerts
5. **Navigation Prompt** - –ü—Ä–µ–¥–ª–æ–∂–µ–Ω–∏–µ –ø–µ—Ä–µ–π—Ç–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É
6. **Quick Actions** - –ö–Ω–æ–ø–∫–∏ –±—ã—Å—Ç—Ä—ã—Ö –¥–µ–π—Å—Ç–≤–∏–π

### Example Usage

```typescript
import { WeatherForecastCard } from '@/components/chat/WeatherForecastCard';
import { RoutePreviewCard, AlertSummaryCard } from '@/components/chat/RouteAndAlertCards';
import { ActionButtons, NavigationPrompt, TypingIndicator } from '@/components/chat/ChatActions';

// In your chat component
<div className="message">
  <p>{message.text}</p>
  
  {message.weather && (
    <WeatherForecastCard
      forecast={message.weather}
      location={message.location}
      compact={true}
    />
  )}
  
  {message.intent?.navigation && (
    <NavigationPrompt
      page={message.intent.navigation.page}
      title="Plan Your Route"
      description="I can help you create a detailed route"
      params={message.intent.navigation.params}
    />
  )}
  
  {message.suggestions && (
    <ActionButtons
      actions={message.suggestions}
      onActionClick={(action) => handleAction(action)}
    />
  )}
</div>
```

## üîß Intent Detection System

### Supported Intents

| Intent Type | Trigger Patterns | Navigation |
|-------------|-----------------|------------|
| `create_route` | "—Ö–æ—á—É –ø–æ–µ—Ö–∞—Ç—å –≤ X", "–º–∞—Ä—à—Ä—É—Ç –∏–∑ X –≤ Y" | `/route?from=X&to=Y` |
| `view_forecast` | "–∫–∞–∫–∞—è –ø–æ–≥–æ–¥–∞", "–ø—Ä–æ–≥–Ω–æ–∑ –Ω–∞ –Ω–µ–¥–µ–ª—é" | `/forecast` |
| `check_alerts` | "–ø—Ä–æ–≤–µ—Ä—å alerts", "–µ—Å—Ç—å –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è" | `/alerts` |
| `view_map` | "–æ—Ç–∫—Ä–æ–π –∫–∞—Ä—Ç—É", "–ø–æ–∫–∞–∂–∏ map" | `/forecast/map` |
| `behavior_prediction` | "–ø–æ–≤–µ–¥–µ–Ω–∏–µ", "prediction" | `/forecast/behavior` |
| `settings` | "–Ω–∞—Å—Ç—Ä–æ–π–∫–∏", "settings" | `/settings` |
| `emergency_sos` | "–ø–æ–º–æ—â—å", "emergency", "SOS" | `/sos` |

### Cities Database

–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ –≥–æ—Ä–æ–¥–∞:
- Astana, –ê—Å—Ç–∞–Ω–∞
- Almaty, –ê–ª–º–∞—Ç—ã
- Shymkent, –®—ã–º–∫–µ–Ω—Ç
- Karaganda, –ö–∞—Ä–∞–≥–∞–Ω–¥–∞
- Aktobe, –ê–∫—Ç–æ–±–µ
- Taraz, –¢–∞—Ä–∞–∑
- Pavlodar, –ü–∞–≤–ª–æ–¥–∞—Ä
- Semey, –°–µ–º–µ–π
- Atyrau, –ê—Ç—ã—Ä–∞—É
- Kostanay, –ö–æ—Å—Ç–∞–Ω–∞–π
- Kyzylorda, –ö—ã–∑—ã–ª–æ—Ä–¥–∞
- Aktau, –ê–∫—Ç–∞—É
- Burabay, –ë—É—Ä–∞–±–∞–π
- Borovoe, –ë–æ—Ä–æ–≤–æ–µ

## üéØ Testing Workflow

### 1. Test Context API
```bash
curl http://localhost:3000/api/chat/context?lat=51.1694&lng=71.4491
```

### 2. Test Intent Detection
**Chat message:** "–Ø —Ö–æ—á—É —Å—ä–µ–∑–¥–∏—Ç—å –∏–∑ –ê—Å—Ç–∞–Ω—ã –≤ –ê–ª–º–∞—Ç—ã"

**Expected:**
- Intent: `create_route`
- Navigation: `/route?from=–ê—Å—Ç–∞–Ω–∞&to=–ê–ª–º–∞—Ç—ã`
- Action command: `CREATE_ROUTE|–ê—Å—Ç–∞–Ω–∞|–ê–ª–º–∞—Ç—ã`

### 3. Test Scheduled Briefing
```bash
curl -X POST http://localhost:3000/api/chat/scheduled \
  -H "Content-Type: application/json" \
  -d '{
    "user_id": "test_user",
    "trigger_time": "2025-10-05T08:00:00Z",
    "trigger_type": "daily_briefing"
  }'
```

### 4. Test Chat UI
1. –û—Ç–∫—Ä–æ–π—Ç–µ `http://localhost:3000/chat`
2. –ù–∞–ø–∏—à–∏—Ç–µ: "–Ø —Ö–æ—á—É –ø–æ–µ—Ö–∞—Ç—å –≤ –ê–ª–º–∞—Ç—ã"
3. –ü—Ä–æ–≤–µ—Ä—å—Ç–µ:
   - ‚úÖ AI –ø–æ–Ω—è–ª –Ω–∞–º–µ—Ä–µ–Ω–∏–µ
   - ‚úÖ –ü–æ–∫–∞–∑–∞–ª RoutePreviewCard
   - ‚úÖ –ü—Ä–µ–¥–ª–æ–∂–∏–ª NavigationPrompt
   - ‚úÖ –ö–Ω–æ–ø–∫–∞ –≤–µ–¥–µ—Ç –Ω–∞ `/route?to=–ê–ª–º–∞—Ç—ã`

## üöÄ Production Deployment

### Environment Variables
```env
OPENAI_API_KEY=sk-...
NEXT_PUBLIC_APP_URL=https://your-domain.com
CLERK_SECRET_KEY=...
```

### Build & Deploy
```bash
npm run build
npm start
```

### Service Worker Integration
–î–ª—è scheduled messages –Ω–∞—Å—Ç—Ä–æ–π—Ç–µ Service Worker:

```javascript
// public/sw.js
self.addEventListener('periodicsync', (event) => {
  if (event.tag === 'daily-briefing') {
    event.waitUntil(fetchAndShowBriefing());
  }
});

async function fetchAndShowBriefing() {
  const response = await fetch('/api/chat/scheduled', {
    method: 'POST',
    body: JSON.stringify({
      trigger_type: 'daily_briefing',
      trigger_time: new Date().toISOString()
    })
  });
  
  const { message } = await response.json();
  
  await self.registration.showNotification(message.greeting, {
    body: message.content.summary,
    icon: '/icons/icon-192x192.png',
    badge: '/icons/badge-72x72.png',
    data: { url: '/chat' }
  });
}
```

## üìä Performance Tips

1. **Lazy Load Components**
```typescript
const WeatherForecastCard = dynamic(() => import('@/components/chat/WeatherForecastCard'));
```

2. **Debounce API Calls**
```typescript
const debouncedSendMessage = useMemo(
  () => debounce(sendMessage, 500),
  []
);
```

3. **Cache Context Data**
```typescript
const { data: context } = useSWR('/api/chat/context', fetcher, {
  revalidateOnFocus: false,
  dedupingInterval: 300000 // 5 minutes
});
```

## üêõ Troubleshooting

### Issue: No context loaded
**Solution:** Check if user is authenticated and location is set

### Issue: Intent not detected
**Solution:** Add more patterns to `intent-detector.ts`

### Issue: Navigation not working
**Solution:** Verify route exists in Next.js routing

### Issue: Streaming not working
**Solution:** Check if API route returns proper Response with `text/event-stream`

## üéâ Success Indicators

‚úÖ Context API returns 200 with full data
‚úÖ Intent detection accuracy > 80%
‚úÖ Chat responds within 2 seconds
‚úÖ Navigation redirects work correctly
‚úÖ Scheduled messages arrive on time
‚úÖ Rich components render properly
‚úÖ Build completes with 0 errors

---

**–†–∞–∑—Ä–∞–±–æ—Ç–∞–Ω–æ –¥–ª—è NASA Space Apps Challenge 2024**
**ResQ - AI-Powered Disaster Prevention & Weather Intelligence System**
